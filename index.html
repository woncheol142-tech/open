<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìœ„ë”ìŠ¤ íƒêµ¬ ë™í˜¸íšŒ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 350px;
            max-height: 400px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 300px;
            }
        }
        .styled-checkbox {
            appearance: none;
            background-color: #e5e7eb;
            width: 2.75rem;
            height: 1.5rem;
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .styled-checkbox::before {
            content: '';
            position: absolute;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            background-color: white;
            top: 0.125rem;
            left: 0.125rem;
            transition: transform 0.2s ease-in-out;
        }
        .styled-checkbox:checked {
            background-color: #3b82f6;
        }
        .styled-checkbox:checked::before {
            transform: translateX(1.25rem);
        }
        .number-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .number-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
        }

        /* --- ëŒ€ì§„í‘œ ìª½ ê³µí†µ ìŠ¤íƒ€ì¼ --- */
        .player-btn {
            width: 100%;
            text-align: left;
            border-radius: 8px;
            border: none;
            padding: 5px 7px;
            background: #fff;
            font-size: 0.82rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.15s ease;
        }
        .player-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .player-seed {
            font-size: 0.7rem;
            color: #999;
            margin-left: 6px;
        }
        .player-btn.empty {
            background: #f7f7f7;
            color: #999;
            cursor: default;
        }
        .player-btn:not(.empty):hover {
            background: #f3f6ff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            transform: translateY(-1px);
        }
        .player-btn.winner {
            background: #e4f2ff;
            border: 1px solid #4a90e2;
            box-shadow: 0 0 0 1px #4a90e233;
            font-weight: 600;
        }
        .match.finished .player-btn:not(.winner) {
            opacity: 0.55;
        }
        .match.finished .player-btn:not(.winner):hover {
            transform: none;
            box-shadow: none;
            background: #fff;
        }
    </style>
</head>

<body class="text-slate-700">
<div class="container mx-auto p-4 md:p-8">
    <!-- í—¤ë” + ì–´ë“œë¯¼ ë²„íŠ¼ -->
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-6">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800">ìœ„ë”ìŠ¤ íƒêµ¬ ë™í˜¸íšŒ </h1>
            <p class="mt-2 text-slate-500 text-sm md:text-base">
                
            </p>
        </div>
        <button
            id="admin-toggle"
            class="self-start md:self-auto inline-flex items-center gap-1 rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-xs md:text-sm text-slate-700 hover:bg-slate-50 shadow-sm">
            ğŸ”’ ê´€ë¦¬ì
        </button>
    </header>

    <!-- íƒ­ ë²„íŠ¼ -->
    <nav class="flex gap-2 mb-6 border-b border-slate-200 pb-2">
        <button id="tab-budget" class="px-4 py-2 rounded-t-lg text-sm md:text-base font-medium bg-white border border-slate-200 border-b-0 shadow-sm">
            ì˜ˆì‚° ê´€ë¦¬
        </button>
        <button id="tab-bracket" class="px-4 py-2 rounded-t-lg text-sm md:text-base font-medium text-slate-500 hover:text-slate-800">
            ëŒ€ì§„í‘œ / ì¶”ì²¨
        </button>
    </nav>

    <main>
        <!-- ================== ì˜ˆì‚° ê´€ë¦¬ ì„¹ì…˜ ================== -->
        <section id="budget-section">
            <!-- Save Button -->
            <div class="flex justify-end mb-6">
                <button id="save-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                    ì €ì¥í•˜ê¸° (ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥)
                </button>
            </div>

            <!-- Key Metrics Section -->
            <section id="key-metrics" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">ìš”ì•½ í˜„í™©</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-sm font-medium text-slate-500">ë™í˜¸íšŒ í†µì¥ ì”ì•¡ (ì…ë ¥)</h3>
                        <input id="club-balance-input" type="text" value="1520350" class="number-input text-3xl font-bold text-slate-800 mt-2 p-0 bg-transparent text-right w-full">
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-sm font-medium text-slate-500">ì´ ì§€ì¶œ</h3>
                        <p id="total-expense" class="text-3xl font-bold text-red-500 mt-2">â‚©0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-sm font-medium text-slate-500">íšŒì‚¬ ì§€ì›ê¸ˆ í•©ê³„</h3>
                        <p id="total-support" class="text-3xl font-bold text-blue-500 mt-2">â‚©0</p>
                    </div>
                    <div class="bg-green-50 p-6 rounded-xl shadow-sm border border-green-200">
                        <h3 class="text-sm font-medium text-green-700">ë‚¨ì€ ìµœì¢… ì”ì•¡</h3>
                        <p id="remaining-balance" class="text-3xl font-bold text-green-600 mt-2">â‚©0</p>
                    </div>
                </div>
            </section>

            <!-- Visualizations Section -->
            <section id="visualizations" class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">ë¹„ìš© ë¶„ì„</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-center mb-4">í•­ëª©ë³„ ì§€ì¶œ êµ¬ì„±</h3>
                        <div class="chart-container">
                            <canvas id="expense-breakdown-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-semibold text-center mb-4">ì§€ì›ê¸ˆ / ë™í˜¸íšŒ ë¶€ë‹´ ë¹„ìœ¨</h3>
                        <div class="chart-container">
                            <canvas id="funding-ratio-chart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Interactive Data Table Section -->
            <section id="data-table">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">ìƒì„¸ ì§€ì¶œ ë‚´ì—­</h2>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-600 uppercase">
                        <tr>
                            <th class="p-4">í•­ëª©</th>
                            <th class="p-4 text-right">ì¸ì›ìˆ˜</th>
                            <th class="p-4 text-right">ì‹¤ì œ ì§€ì¶œ</th>
                            <th class="p-4 text-center">íšŒì‚¬ ì§€ì›</th>
                            <th class="p-4 text-right">íšŒì‚¬ ì§€ì›ê¸ˆ</th>
                            <th class="p-4 text-right">ë™í˜¸íšŒ ë¶€ë‹´</th>
                            <th class="p-4 hidden md:table-cell">ë¹„ê³ </th>
                        </tr>
                        </thead>
                        <tbody id="budget-table-body" class="divide-y divide-slate-200">
                        <!-- JSì—ì„œ ìƒì„± -->
                        </tbody>
                        <tfoot class="bg-slate-100 font-bold">
                        <tr>
                            <td class="p-4">ì´ê³„</td>
                            <td class="p-4"></td>
                            <td id="total-expense-footer" class="p-4 text-right">â‚©0</td>
                            <td class="p-4"></td>
                            <td id="total-support-footer" class="p-4 text-right">â‚©0</td>
                            <td id="total-burden-footer" class="p-4 text-right">â‚©0</td>
                            <td class="p-4 hidden md:table-cell"></td>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </section>

            <!-- AI ì§€ì› ì„¹ì…˜ -->
            <section id="ai-helper" class="mt-8">
                <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between mb-2">
                    <div>
                        <h2 class="text-2xl font-semibold text-slate-800">AI ë„ì›€ ë°›ê¸°</h2>
                        <p class="text-slate-500 text-sm md:text-base mt-1">í˜„ì¬ ì˜ˆì‚°, ì°¸ê°€ì, ê²½ê¸° ê²°ê³¼ë¥¼ í•œ ë²ˆì— ìš”ì•½í•œ í”„ë¡¬í”„íŠ¸ì…ë‹ˆë‹¤. ì´ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ ì‚¬ë‚´ LLM/ì™¸ë¶€ AI APIì— ë¶™ì—¬ë„£ì–´ ë¶„ì„, í†µê³„ ì„¤ëª…, ìš”ì•½ ê³µì§€ ì´ˆì•ˆ ì‘ì„± ë“±ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
                    </div>
                    <div class="flex gap-2 self-start md:self-auto">
                        <button id="ai-refresh" class="bg-white border border-slate-300 text-slate-700 px-3 py-2 text-sm rounded-lg shadow-sm hover:bg-slate-50">ë‚´ìš© ìƒˆë¡œê³ ì¹¨</button>
                        <button id="ai-copy" class="bg-blue-600 text-white px-3 py-2 text-sm rounded-lg shadow hover:bg-blue-700">í”„ë¡¬í”„íŠ¸ ë³µì‚¬</button>
                    </div>
                </div>
                <div class="bg-white border border-dashed border-slate-300 rounded-xl p-4 shadow-sm">
                    <div class="flex items-center justify-between text-xs text-slate-500 mb-2">
                        <span>AIì—ê²Œ ë³´ë‚¼ ìš”ì•½</span>
                        <span id="ai-status" class="text-[11px] text-blue-600">ìë™ ìƒì„±ë¨</span>
                    </div>
                    <textarea id="ai-prompt" class="w-full h-48 text-sm text-slate-800 border border-slate-200 rounded-lg p-3 bg-slate-50" readonly></textarea>
                    <p class="text-[11px] text-slate-500 mt-2 leading-5">
                        Â· ì‚¬ë‚´ í”„ë¡ì‹œë‚˜ ì„œë²„ ì¸¡ ì—”ë“œí¬ì¸íŠ¸ì— <code>ai-helper</code> í…ìŠ¤íŠ¸ë¥¼ POSTí•˜ë„ë¡ ì—°ê²°í•´ ë‘ë©´, ë²„íŠ¼ë§Œìœ¼ë¡œë„ AI í˜¸ì¶œì„ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        Â· ì˜ˆ: <code>fetch('/api/ai', { method: 'POST', body: JSON.stringify({ prompt: document.getElementById('ai-prompt').value }) })</code><br>
                        Â· í˜¸ì¶œ ê²°ê³¼ë¥¼ <em>ëŒ€ì§„í‘œ ê³µì§€</em>ë‚˜ <em>ì˜ˆì‚° ë³´ê³ ì„œ</em>ì— ë°˜ì˜í•˜ëŠ” ì‹ìœ¼ë¡œ í™•ì¥í•´ ë³´ì„¸ìš”.
                    </p>
                </div>
            </section>
        </section>

        <!-- ================== ëŒ€ì§„í‘œ / ì¶”ì²¨ ì„¹ì…˜ ================== -->
        <section id="bracket-section" class="hidden">
            <section class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800">ëŒ€ì§„í‘œ / ì¶”ì²¨ ë²ˆí˜¸ ìƒì„±ê¸°</h2>
                <p class="text-slate-500 mb-4 text-sm md:text-base">
                    ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•˜ë©´ â–¶ ëœë¤ ì¶”ì²¨ë²ˆí˜¸ â–¶ 16ê°• í† ë„ˆë¨¼íŠ¸ ìë™ êµ¬ì„± â–¶ ê²½ê¸° ê²°ê³¼ë¥¼ í´ë¦­í•´ ìš°ìŠ¹Â·ì¤€ìš°ìŠ¹ì„ ìë™ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
                </p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6">
                    <!-- ì°¸ê°€ì ì…ë ¥ -->
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-slate-800">1. ì°¸ê°€ì ì´ë¦„ ì…ë ¥</span>
                            <span class="text-xs text-slate-500">í•œ ì¤„ì— í•œ ëª…ì”© (ìµœëŒ€ 16ëª…, 14ëª… ê¶Œì¥)</span>
                        </div>

                        <!-- ğŸ”¹ ë‹¨ì‹ / ë³µì‹ ì„ íƒ -->
                        <div class="flex items-center gap-4 mb-3 text-xs text-slate-600">
                            <label class="inline-flex items-center gap-1">
                                <input type="radio" name="matchType" value="single" class="h-3 w-3" checked>
                                <span>ë‹¨ì‹</span>
                            </label>

                            <label class="inline-flex items-center gap-1">
                                <input type="radio" name="matchType" value="double" class="h-3 w-3">
                                <span>ë³µì‹</span>
                            </label>

                            <span class="text-[11px] text-slate-400">
                                ë³µì‹ ì„ íƒ ì‹œ ì…ë ¥ëœ ì´ë¦„ ë‘ ëª…ì”© í•œ íŒ€ìœ¼ë¡œ ìë™ ë¬¶ì…ë‹ˆë‹¤.
                            </span>
                        </div>

                        <textarea id="bracket-playerInput"
                                  class="w-full min-h-[150px] resize-y p-2 border border-slate-300 rounded-lg text-sm"
                                  placeholder="ì˜ˆ)
í™ê¸¸ë™
ê¹€ì² ìˆ˜
â€¦ ì´ëŸ° ì‹ìœ¼ë¡œ ì¤„ë§ˆë‹¤ í•œ ëª…ì”© ì…ë ¥í•˜ì„¸ìš”."></textarea>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <button id="bracket-generateBtn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 text-sm rounded-lg shadow">
                                ëœë¤ ì¶”ì²¨ &amp; ëŒ€ì§„í‘œ ìƒì„±
                            </button>
                            <button id="bracket-resetBtn"
                                    class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 text-sm rounded-lg border border-slate-300">
                                ì´ˆê¸°í™”
                            </button>
                        </div>
                        <p class="mt-2 text-xs text-slate-500 leading-5">
                            Â· 14ëª… ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ <b>16ê°• í† ë„ˆë¨¼íŠ¸</b> + <b>ë¶€ì „ìŠ¹</b>ìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.<br>
                            Â· ì´ë¯¸ ìƒì„±ëœ ìƒíƒœì—ì„œ ë‹¤ì‹œ ëˆ„ë¥´ë©´ <b>ìƒˆë¡œ ëœë¤ ì¶”ì²¨</b>í•©ë‹ˆë‹¤.<br>
                            Â· ìœ„ìª½ <b>ì €ì¥í•˜ê¸°</b> ë²„íŠ¼ ëˆ„ë¥´ë©´ ì´ ì´ë¦„ ëª©ë¡ë„ ê°™ì´ ì €ì¥ë©ë‹ˆë‹¤.
                        </p>
                    </div>

                    <!-- ì‹œë“œ í‘œ -->
                    <div class="bg-white p-4 md:p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-semibold text-slate-800">2. ì¶”ì²¨ ë²ˆí˜¸ / ì‹œë“œ í™•ì¸</span>
                            <span class="text-xs text-slate-500">ëŒ€ì§„í‘œì—ì„œì˜ ìë¦¬ ë²ˆí˜¸</span>
                        </div>
                        <div id="bracket-seedContainer" class="text-sm">
                            <p class="text-xs text-slate-500">
                                ì™¼ìª½ì— ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•˜ê³ <br>
                                <b>ã€Œëœë¤ ì¶”ì²¨ &amp; ëŒ€ì§„í‘œ ìƒì„±ã€</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- ëŒ€ì§„í‘œ -->
                <div id="bracket-bracket" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-semibold text-slate-800">3. ê²½ê¸° ê²°ê³¼ ì…ë ¥</span>
                        <span class="text-xs text-slate-500">ê° ê²½ê¸°ì—ì„œ ì´ê¸´ ì‚¬ëŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</span>
                    </div>
                    <div id="bracket-bracketInner" class="overflow-x-auto pb-2">
                        <!-- JSë¡œ ìƒì„± -->
                    </div>
                </div>

                <!-- ìµœì¢… ê²°ê³¼ -->
                <div id="bracket-result" class="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6 mt-4 hidden">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-semibold text-slate-800">4. ìµœì¢… ê²°ê³¼</span>
                        <span class="text-xs text-slate-500">ê²°ìŠ¹ ê²°ê³¼ê°€ ì…ë ¥ë˜ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</span>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <div class="flex-1 min-w-[160px] bg-green-50 border border-green-200 rounded-lg px-3 py-2">
                            <div class="text-xs text-green-700 mb-1">ìš°ìŠ¹</div>
                            <div id="bracket-winnerName" class="text-lg font-bold text-green-700">-</div>
                        </div>
                        <div class="flex-1 min-w-[160px] bg-slate-50 border border-slate-200 rounded-lg px-3 py-2">
                            <div class="text-xs text-slate-600 mb-1">ì¤€ìš°ìŠ¹</div>
                            <div id="bracket-runnerUpName" class="text-lg font-bold text-slate-800">-</div>
                        </div>
                    </div>
                </div>
            </section>
        </section>
    </main>
</div>

<!-- ================== ì˜ˆì‚° ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ================== -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fixedFoodSupportRate = 25000;
        const fixedVenueSupportRate = 15000;

        let budgetData = [
            { id: 1, item: 'ì‹ë¹„',       costPerPerson: 20000, people: 11, actualExpense: 200000, isCompanySupported: true,  notes: 'ì ì‹¬ ì‹ì‚¬' },
            { id: 2, item: 'ì¥ì†Œ ëŒ€ì—¬ë£Œ', costPerPerson: 15000, people: 1,  actualExpense: 15000,  isCompanySupported: true,  notes: 'ì²´ìœ¡ê´€' },
            { id: 3, item: 'ì°¸ê°€ë¹„',     costPerPerson: 10000, people: 10, actualExpense: 100000, isCompanySupported: false, notes: 'ëŒ€íšŒ ì°¸ê°€ë£Œ' },
            { id: 4, item: 'ìƒí’ˆ',       costPerPerson: 50000, people: 3,  actualExpense: 150000, isCompanySupported: false, notes: 'ì‹œìƒìš©' },
            { id: 5, item: 'ê¸°íƒ€',       costPerPerson: 10000, people: 2,  actualExpense: 20000,  isCompanySupported: false, notes: 'ì˜ˆë¹„ë¹„Â·ì†Œëª¨í’ˆ' },
        ];

        const STORAGE_KEY = 'withersDashboard';   // ì˜ˆì‚° + ì´ë¦„ ê°™ì´ ì €ì¥
        const clubBalanceInput = document.getElementById('club-balance-input');
        const saveButton = document.getElementById('save-button');
        const aiPromptEl = document.getElementById('ai-prompt');
        const aiRefreshBtn = document.getElementById('ai-refresh');
        const aiCopyBtn = document.getElementById('ai-copy');
        const aiStatusEl = document.getElementById('ai-status');

        const formatNumber = (amount) => {
            return new Intl.NumberFormat('ko-KR').format(amount);
        };
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(amount);
        };
        const parseNumericValue = (rawValue) => {
            const numericString = String(rawValue).replace(/[^\d]/g, '');
            return parseInt(numericString) || 0;
        };

        const getBudgetSnapshot = () => {
            const totalExpense = budgetData.reduce((sum, d) => sum + d.actualExpense, 0);
            const totalSupport = budgetData.reduce((sum, d) => sum + d.companySupportAmount, 0);
            const totalBurden = budgetData.reduce((sum, d) => sum + d.clubBurden, 0);
            const initialClubBalance = parseNumericValue(clubBalanceInput.value);
            const remainingBalance = initialClubBalance + totalSupport - totalExpense;

            return {
                totals: { initialClubBalance, totalExpense, totalSupport, totalBurden, remainingBalance },
                rows: budgetData.map((d) => ({
                    item: d.item,
                    people: d.people,
                    actualExpense: d.actualExpense,
                    isCompanySupported: d.isCompanySupported,
                    companySupportAmount: d.companySupportAmount,
                    clubBurden: d.clubBurden,
                    notes: d.notes
                }))
            };
        };

        const getBracketSnapshot = () => {
            const bracketInputEl = document.getElementById('bracket-playerInput');
            const winnerNameEl = document.getElementById('bracket-winnerName');
            const runnerUpNameEl = document.getElementById('bracket-runnerUpName');

            const players = bracketInputEl
                ? bracketInputEl.value
                    .split("\n")
                    .map((v) => v.trim())
                    .filter((v) => v.length > 0)
                : [];

            return {
                players,
                winner: winnerNameEl ? winnerNameEl.textContent : "-",
                runnerUp: runnerUpNameEl ? runnerUpNameEl.textContent : "-"
            };
        };

        const buildAiPrompt = () => {
            const budget = getBudgetSnapshot();
            const bracket = getBracketSnapshot();
            const payload = {
                context: "Withers íƒêµ¬ ë™í˜¸íšŒ ì´ë²¤íŠ¸ ë°ì´í„° ìš”ì•½",
                budget,
                bracket,
                guidance: [
                    "ì˜ˆì‚° ì§€ì¶œ íŒ¨í„´ ìš”ì•½", "ì§€ì›ê¸ˆ/ë¶€ë‹´ ë¹„ìœ¨ ì„¤ëª…", "ì°¸ê°€ì ë° ìš°ìŠ¹ì ê³µì§€ ì´ˆì•ˆ", "ì¶”ê°€ êµ¬ë§¤/ì ˆì•½ ì œì•ˆ"
                ]
            };

            return [
                "ì•„ë˜ JSONì„ ë¶„ì„í•´ 5ì¤„ ì´ë‚´ë¡œ í•œêµ­ì–´ ìš”ì•½ì„ ì‘ì„±í•˜ê³ , í•„ìš”í•œ ê²½ìš° ì¶”ê°€ ì§ˆë¬¸ì„ ì œì•ˆí•˜ì„¸ìš”.",
                JSON.stringify(payload, null, 2)
            ].join("\n\n");
        };

        const updateAiPrompt = () => {
            if (!aiPromptEl) return;
            aiPromptEl.value = buildAiPrompt();
            if (aiStatusEl) {
                aiStatusEl.textContent = `ìë™ ìƒì„±ë¨ Â· ${new Date().toLocaleTimeString('ko-KR')}`;
            }
        };

        const copyAiPrompt = async () => {
            if (!aiPromptEl) return;
            const text = aiPromptEl.value;
            try {
                await navigator.clipboard.writeText(text);
                if (aiStatusEl) aiStatusEl.textContent = 'í´ë¦½ë³´ë“œì— ë³µì‚¬ ì™„ë£Œ';
            } catch (err) {
                if (aiStatusEl) aiStatusEl.textContent = 'ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”';
            }
        };

        const saveDataToStorage = () => {
            const bracketInputEl = document.getElementById('bracket-playerInput');
            const dataToSave = {
                budgetData: budgetData,
                clubBalance: parseNumericValue(clubBalanceInput.value),
                bracketPlayers: bracketInputEl ? bracketInputEl.value : ""
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            saveButton.textContent = 'âœ… ì €ì¥ ì™„ë£Œ!';
            setTimeout(() => {
                saveButton.textContent = 'ì €ì¥í•˜ê¸° (ë¸Œë¼ìš°ì €ì— ì„ì‹œ ì €ì¥)';
            }, 2000);
        };

        const loadDataFromStorage = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                if (parsedData.budgetData) {
                    budgetData = parsedData.budgetData;
                }
                if (typeof parsedData.clubBalance !== "undefined") {
                    clubBalanceInput.value = parsedData.clubBalance;
                }
                if (typeof parsedData.bracketPlayers === "string") {
                    const bracketInputEl = document.getElementById('bracket-playerInput');
                    if (bracketInputEl) {
                        bracketInputEl.value = parsedData.bracketPlayers;
                    }
                }
            }
        };

        const updateDataAndRecalculate = (id, field, value) => {
            const dataItem = budgetData.find(d => d.id === id);
            if (dataItem) {
                dataItem[field] = Math.max(0, value);
            }
            calculateValues();
        };

        const calculateValues = () => {
            budgetData.forEach(d => {
                let supportCap = 0;
                let companySupportAmount = 0;

                if (d.item === 'ì‹ë¹„') {
                    supportCap = fixedFoodSupportRate * d.people;
                } else if (d.item === 'ì¥ì†Œ ëŒ€ì—¬ë£Œ') {
                    supportCap = fixedVenueSupportRate * d.people;
                }

                if (d.isCompanySupported) {
                    if (d.item === 'ì‹ë¹„' || d.item === 'ì¥ì†Œ ëŒ€ì—¬ë£Œ') {
                        companySupportAmount = supportCap;
                    } else {
                        companySupportAmount = d.actualExpense;
                    }
                }

                d.companySupportAmount = companySupportAmount;

                if (d.item === 'ì¥ì†Œ ëŒ€ì—¬ë£Œ' && d.isCompanySupported) {
                    d.clubBurden = 0;
                } else {
                    d.clubBurden = Math.max(0, d.actualExpense - d.companySupportAmount);
                }
            });
        };

        const renderTable = () => {
            const tableBody = document.getElementById('budget-table-body');
            tableBody.innerHTML = '';
            budgetData.forEach(d => {
                const rowBgClass = d.isCompanySupported ? 'bg-[#EAF2FD]' : 'bg-[#F2F2F2]';
                const row = document.createElement('tr');
                row.className = `hover:bg-slate-50 ${rowBgClass}`;
                row.innerHTML = `
                    <td class="p-4 font-medium">${d.item}</td>
                    <td class="p-4 text-right">
                        <input type="number" value="${d.people}" data-id="${d.id}" data-field="people" class="number-input text-right w-16">
                    </td>
                    <td class="p-4 text-right">
                        <input type="text" value="${formatNumber(d.actualExpense)}" data-id="${d.id}" data-field="actualExpense" class="number-input text-right w-40">
                    </td>
                    <td class="p-4 text-center">
                        <input type="checkbox" ${d.isCompanySupported ? 'checked' : ''} data-id="${d.id}" data-field="isCompanySupported" class="styled-checkbox">
                    </td>
                    <td class="p-4 text-right text-blue-600">${formatCurrency(d.companySupportAmount)}</td>
                    <td class="p-4 text-right text-orange-600">${formatCurrency(d.clubBurden)}</td>
                    <td class="p-4 text-slate-500 hidden md:table-cell">${d.notes}</td>
                `;
                tableBody.appendChild(row);
            });

            document.querySelectorAll('#budget-table-body input[data-field="people"]').forEach(input => {
                input.addEventListener('input', handlePeopleChange);
            });
            document.querySelectorAll('#budget-table-body input[data-field="actualExpense"]').forEach(input => {
                input.addEventListener('input', handleExpenseInput);
                input.addEventListener('blur', handleExpenseBlur);
            });
            document.querySelectorAll('#budget-table-body input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', handleCheckboxChange);
            });
        };

        const handlePeopleChange = (e) => {
            const id = parseInt(e.target.dataset.id);
            const value = parseNumericValue(e.target.value);
            const dataItem = budgetData.find(d => d.id === id);

            if (dataItem) {
                dataItem.people = Math.max(0, value);

                if (id === 2 || id === 3) {
                    dataItem.actualExpense = dataItem.people * dataItem.costPerPerson;
                }
            }
            updateDataAndRecalculate(id, 'people', dataItem.people);
            fullUpdate();
        };

        const handleExpenseInput = (e) => {
            const id = parseInt(e.target.dataset.id);
            const value = parseNumericValue(e.target.value);
            updateDataAndRecalculate(id, 'actualExpense', value);
            updateUI();
        };

        const handleExpenseBlur = () => {
            fullUpdate();
        };

        const getClubBalance = () => {
            return parseNumericValue(clubBalanceInput.value);
        };

        const handleClubBalanceInput = () => {
            updateUI();
        };

        const handleClubBalanceBlur = () => {
            const value = parseNumericValue(clubBalanceInput.value);
            clubBalanceInput.value = formatCurrency(value);
            fullUpdate();
        };

        const updateUI = () => {
            const initialClubBalance = getClubBalance();

            const totalExpense = budgetData.reduce((sum, d) => sum + d.actualExpense, 0);
            const totalSupport = budgetData.reduce((sum, d) => sum + d.companySupportAmount, 0);
            const totalBurden = budgetData.reduce((sum, d) => sum + d.clubBurden, 0);
            const remainingBalance = initialClubBalance + totalSupport - totalExpense;

            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
            document.getElementById('total-support').textContent = formatCurrency(totalSupport);
            document.getElementById('remaining-balance').textContent = formatCurrency(remainingBalance);

            document.getElementById('total-expense-footer').textContent = formatCurrency(totalExpense);
            document.getElementById('total-support-footer').textContent = formatCurrency(totalSupport);
            document.getElementById('total-burden-footer').textContent = formatCurrency(totalBurden);

            updateCharts(totalSupport, totalBurden);
            updateAiPrompt();
        };

        const handleCheckboxChange = (e) => {
            const id = parseInt(e.target.dataset.id);
            const isChecked = e.target.checked;
            const dataItem = budgetData.find(d => d.id === id);
            if (dataItem) {
                dataItem.isCompanySupported = isChecked;
            }
            fullUpdate();
        };

        const fullUpdate = () => {
            calculateValues();
            renderTable();
            updateUI();
        };

        if (aiRefreshBtn) aiRefreshBtn.addEventListener('click', updateAiPrompt);
        if (aiCopyBtn) aiCopyBtn.addEventListener('click', copyAiPrompt);
        window.rebuildAiPrompt = updateAiPrompt;

        let expenseChart, fundingChart;

        const createCharts = () => {
            const expenseCtx = document.getElementById('expense-breakdown-chart').getContext('2d');
            expenseChart = new Chart(expenseCtx, {
                type: 'bar',
                data: {
                    labels: budgetData.map(d => d.item),
                    datasets: [
                        {
                            label: 'ì‹¤ì œ ì§€ì¶œ',
                            data: budgetData.map(d => d.actualExpense),
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'íšŒì‚¬ ì§€ì›ê¸ˆ',
                            data: budgetData.map(d => d.companySupportAmount),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ë™í˜¸íšŒ ë¶€ë‹´',
                            data: budgetData.map(d => d.clubBurden),
                            backgroundColor: 'rgba(249, 115, 22, 0.6)',
                            borderColor: 'rgba(249, 115, 22, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚©' + (value / 1000) + 'k';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });

            const fundingCtx = document.getElementById('funding-ratio-chart').getContext('2d');
            fundingChart = new Chart(fundingCtx, {
                type: 'doughnut',
                data: {
                    labels: ['íšŒì‚¬ ì§€ì›ê¸ˆ', 'ë™í˜¸íšŒ ë¶€ë‹´'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(249, 115, 22, 0.7)'],
                        borderColor: ['#ffffff'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.chart.getDatasetMeta(0).total;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return `${label}: ${formatCurrency(value)} (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });
        };

        const updateCharts = (totalSupport, totalBurden) => {
            if (!expenseChart || !fundingChart) return;
            expenseChart.data.datasets[0].data = budgetData.map(d => d.actualExpense);
            expenseChart.data.datasets[1].data = budgetData.map(d => d.companySupportAmount);
            expenseChart.data.datasets[2].data = budgetData.map(d => d.clubBurden);
            expenseChart.update();

            fundingChart.data.datasets[0].data = [totalSupport, totalBurden];
            fundingChart.update();
        };

        loadDataFromStorage();
        clubBalanceInput.value = formatCurrency(parseNumericValue(clubBalanceInput.value));

        clubBalanceInput.addEventListener('input', handleClubBalanceInput);
        clubBalanceInput.addEventListener('blur', handleClubBalanceBlur);
        saveButton.addEventListener('click', saveDataToStorage);

        createCharts();
        fullUpdate();
    });
</script>

<!-- ================== íƒ­ ì „í™˜ + ëŒ€ì§„í‘œ + ì–´ë“œë¯¼ ëª¨ë“œ ìŠ¤í¬ë¦½íŠ¸ ================== -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const budgetSection = document.getElementById('budget-section');
        const bracketSection = document.getElementById('bracket-section');
        const tabBudget = document.getElementById('tab-budget');
        const tabBracket = document.getElementById('tab-bracket');
        const adminToggleBtn = document.getElementById('admin-toggle');

        // ì–´ë“œë¯¼ ëª¨ë“œ ì—¬ë¶€ (localStorageì— ì €ì¥)
        let adminMode = localStorage.getItem('withersAdmin') === '1';

        const activateBudgetTabStyle = () => {
            tabBudget.classList.add('bg-white', 'border', 'border-slate-200', 'border-b-0', 'shadow-sm');
            tabBudget.classList.remove('text-slate-500');
            tabBracket.classList.remove('bg-white', 'border', 'border-slate-200', 'border-b-0', 'shadow-sm');
            tabBracket.classList.add('text-slate-500');
        };

        const activateBracketTabStyle = () => {
            tabBracket.classList.add('bg-white', 'border', 'border-slate-200', 'border-b-0', 'shadow-sm');
            tabBracket.classList.remove('text-slate-500');
            tabBudget.classList.remove('bg-white', 'border', 'border-slate-200', 'border-b-0', 'shadow-sm');
            tabBudget.classList.add('text-slate-500');
        };

        const showBudget = () => {
            if (!adminMode) return; // ì–´ë“œë¯¼ì´ ì•„ë‹ˆë©´ ë°©ì–´
            budgetSection.classList.remove('hidden');
            bracketSection.classList.add('hidden');
            activateBudgetTabStyle();
        };

        const showBracket = () => {
            budgetSection.classList.add('hidden');
            bracketSection.classList.remove('hidden');
            activateBracketTabStyle();
        };

        // ì–´ë“œë¯¼ UI ì ìš©
        const applyAdminUI = () => {
            if (adminMode) {
                tabBudget.classList.remove('hidden');
                adminToggleBtn.textContent = 'ğŸ”“ ì–´ë“œë¯¼ ëª¨ë“œ í•´ì œ';
                // ê¸°ë³¸ í™”ë©´: ì˜ˆì‚° íƒ­
                showBudget();
            } else {
                tabBudget.classList.add('hidden'); // íƒ­ ìì²´ ìˆ¨ê¹€
                showBracket(); // ì¼ë°˜ ìœ ì €ëŠ” ëŒ€ì§„í‘œë§Œ
                adminToggleBtn.textContent = 'ğŸ”’ ì–´ë“œë¯¼ ëª¨ë“œ';
            }
        };

        tabBudget.addEventListener('click', showBudget);
        tabBracket.addEventListener('click', showBracket);

        adminToggleBtn.addEventListener('click', () => {
            if (!adminMode) {
                const code = prompt('ì–´ë“œë¯¼ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
                if (code === 'cwc') {
                    adminMode = true;
                    localStorage.setItem('withersAdmin', '1');
                    applyAdminUI();
                } else if (code !== null) {
                    alert('ì½”ë“œê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
            } else {
                if (confirm('ì–´ë“œë¯¼ ëª¨ë“œë¥¼ í•´ì œí• ê¹Œìš”? (ì˜ˆì‚° íƒ­ì´ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤)')) {
                    adminMode = false;
                    localStorage.setItem('withersAdmin', '0');
                    applyAdminUI();
                }
            }
        });

        // ì²˜ìŒ ë¡œë“œ ì‹œ ìƒíƒœ ë°˜ì˜
        applyAdminUI();

        // ===== ëŒ€ì§„í‘œ ë¡œì§ =====
        let bracketData = null;
        let bracketSize = 16;
        let seedsForDisplay = [];

        // ğŸ”¹ ë‹¨ì‹/ë³µì‹ ëª¨ë“œ
        let matchType = 'single';
        window.withersMatchType = matchType;

        const playerInputEl   = document.getElementById("bracket-playerInput");
        const generateBtn     = document.getElementById("bracket-generateBtn");
        const resetBtn        = document.getElementById("bracket-resetBtn");
        const seedContainer   = document.getElementById("bracket-seedContainer");
        const bracketEl       = document.getElementById("bracket-bracket");
        const bracketInnerEl  = document.getElementById("bracket-bracketInner");
        const resultEl        = document.getElementById("bracket-result");
        const winnerNameEl    = document.getElementById("bracket-winnerName");
        const runnerUpNameEl  = document.getElementById("bracket-runnerUpName");

        // ğŸ”¹ ë‹¨ì‹ / ë³µì‹ ë¼ë””ì˜¤ ë²„íŠ¼
        const matchTypeRadios = document.querySelectorAll('input[name="matchType"]');
        matchTypeRadios.forEach((radio) => {
            radio.addEventListener('change', (e) => {
                matchType = e.target.value;          // 'single' or 'double'
                window.withersMatchType = matchType;
                // ëª¨ë“œ ë°”ë€Œë©´ ëŒ€ì§„í‘œ ì´ˆê¸°í™”
                resetBracket();
                if (window.rebuildAiPrompt) window.rebuildAiPrompt();
            });
        });

        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const getBracketSize = (playerCount) => {
            if (playerCount <= 2) return 2;
            if (playerCount <= 4) return 4;
            if (playerCount <= 8) return 8;
            return 16;
        };

        const renderSeedTable = (players, size) => {
            seedsForDisplay = players.slice();
            let html = '<table class="w-full text-xs border border-slate-200 text-left">';
            html += '<thead class="bg-slate-50 text-slate-600"><tr><th class="px-2 py-1 border-b border-slate-200">ì‹œë“œ</th><th class="px-2 py-1 border-b border-slate-200">ì´ë¦„</th></tr></thead><tbody>';

            for (let i = 0; i < size; i++) {
                const name = players[i] || "";
                const isBye = name === "ë¶€ì „ìŠ¹";
                html += '<tr class="border-b border-slate-100">';
                html += `<td class="px-2 py-1">${i + 1}</td>`;
                if (name) {
                    html += `<td class="px-2 py-1">${name}${isBye ? ' <span class="inline-block text-[10px] px-2 py-[1px] rounded-full bg-slate-100 text-slate-600">ë¶€ì „ìŠ¹</span>' : ''}</td>`;
                } else {
                    html += '<td class="px-2 py-1 text-slate-400">(ë¹ˆ ìë¦¬)</td>';
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            html += '<p class="mt-1 text-[11px] text-slate-500">Â· ì‹œë“œ ë²ˆí˜¸ëŠ” 16ê°• ëŒ€ì§„í‘œì—ì„œì˜ ìë¦¬ì…ë‹ˆë‹¤.<br>Â· ë¶€ì „ìŠ¹ì€ ê²½ê¸°ë¥¼ ì¹˜ë¥´ì§€ ì•Šê³  ë‹¤ìŒ ë¼ìš´ë“œë¡œ ìë™ ì§„ì¶œí•©ë‹ˆë‹¤.</p>';
            seedContainer.innerHTML = html;
        };

        const initBracketStructure = (size) => {
            const rounds = [];
            let currentSize = size;
            while (currentSize >= 2) {
                const matchCount = currentSize / 2;
                const round = [];
                for (let i = 0; i < matchCount; i++) {
                    round.push({ players: ["", ""], winner: null });
                }
                rounds.push(round);
                currentSize = matchCount;
            }
            return rounds;
        };

        const renderBracketDOM = () => {
            bracketInnerEl.innerHTML = "";
            if (!bracketData) return;

            const roundNames = ["16ê°•", "8ê°•", "4ê°•", "ê²°ìŠ¹"];

            const wrapper = document.createElement("div");
            wrapper.className = "grid grid-flow-col auto-cols-[minmax(180px,1fr)] gap-3 min-w-[720px]";

            bracketData.forEach((round, rIndex) => {
                const roundDiv = document.createElement("div");
                roundDiv.className = "flex flex-col gap-2";

                const title = document.createElement("div");
                title.className = "text-xs font-semibold text-slate-600 mb-1";
                title.textContent = roundNames[rIndex] || `R${rIndex + 1}`;
                roundDiv.appendChild(title);

                round.forEach((match, mIndex) => {
                    const matchDiv = document.createElement("div");
                    matchDiv.className = "match border border-slate-200 bg-slate-50 rounded-lg px-2 py-1.5 flex flex-col gap-1.5";
                    matchDiv.dataset.roundIndex = rIndex;
                    matchDiv.dataset.matchIndex = mIndex;

                    const header = document.createElement("div");
                    header.className = "text-[11px] text-slate-500";
                    header.textContent = `${roundNames[rIndex] || "R" + (rIndex + 1)} ${mIndex + 1}ê²½ê¸°`;
                    matchDiv.appendChild(header);

                    for (let slotIndex = 0; slotIndex < 2; slotIndex++) {
                        const slotDiv = document.createElement("div");
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "player-btn";
                        btn.dataset.playerSlot = slotIndex;

                        const nameSpan = document.createElement("span");
                        nameSpan.className = "player-name";
                        nameSpan.textContent = match.players[slotIndex] || "";

                        const seedSpan = document.createElement("span");
                        seedSpan.className = "player-seed";

                        btn.appendChild(nameSpan);
                        btn.appendChild(seedSpan);
                        slotDiv.appendChild(btn);
                        matchDiv.appendChild(slotDiv);
                    }

                    roundDiv.appendChild(matchDiv);
                });

                wrapper.appendChild(roundDiv);
            });

            bracketInnerEl.appendChild(wrapper);
            bracketEl.classList.remove("hidden");
        };

        const refreshMatchTexts = () => {
            if (!bracketData) return;

            const matchDivs = bracketInnerEl.querySelectorAll(".match");
            matchDivs.forEach(matchDiv => {
                const rIndex = parseInt(matchDiv.dataset.roundIndex, 10);
                const mIndex = parseInt(matchDiv.dataset.matchIndex, 10);
                const data = bracketData[rIndex][mIndex];

                matchDiv.classList.remove("finished");
                const buttons = matchDiv.querySelectorAll(".player-btn");

                buttons.forEach((btn, slot) => {
                    const name = data.players[slot] || "";
                    const nameSpan = btn.querySelector(".player-name");
                    const seedSpan = btn.querySelector(".player-seed");

                    btn.classList.remove("winner", "empty");
                    nameSpan.textContent = name || "ëŒ€ê¸°";
                    seedSpan.textContent = "";

                    if (!name) {
                        btn.classList.add("empty");
                        nameSpan.style.color = "#999";
                    } else {
                        nameSpan.style.color = "#111827";
                        if (name === "ë¶€ì „ìŠ¹") {
                            seedSpan.textContent = "ë¶€ì „ìŠ¹";
                            seedSpan.style.color = "#b91c1c";
                        } else {
                            const seedIndex = seedsForDisplay.indexOf(name);
                            if (seedIndex !== -1) {
                                seedSpan.textContent = `#${seedIndex + 1}`;
                                seedSpan.style.color = "#6b7280";
                            }
                        }
                    }
                });

                if (data.winner) {
                    const winnerButtons = Array.from(buttons).filter(
                        (btn) => btn.querySelector(".player-name").textContent === data.winner
                    );
                    if (winnerButtons.length > 0) {
                        winnerButtons[0].classList.add("winner");
                    }
                    matchDiv.classList.add("finished");
                }
            });
        };

        // ğŸ” ë¶€ì „ìŠ¹ ìë™ ì§„ì¶œ (ì—°ì‡„ ì²˜ë¦¬ + "ë¶€ì „ìŠ¹"ë§Œ byeë¡œ ì¸ì •)
        const autoAdvanceByes = () => {
            if (!bracketData) return;

            let changed = true;
            while (changed) {
                changed = false;

                for (let rIndex = 0; rIndex < bracketData.length; rIndex++) {
                    const round = bracketData[rIndex];

                    for (let mIndex = 0; mIndex < round.length; mIndex++) {
                        const match = round[mIndex];
                        const [p1, p2] = match.players;

                        // ì´ë¯¸ ìŠ¹ì ìˆìœ¼ë©´ íŒ¨ìŠ¤
                        if (match.winner) continue;

                        // ì˜¤ì§ "ë¶€ì „ìŠ¹" ë¬¸ìì—´ë§Œ byeë¡œ ì¸ì •
                        const p1IsBye = p1 === "ë¶€ì „ìŠ¹";
                        const p2IsBye = p2 === "ë¶€ì „ìŠ¹";

                        let autoWinner = null;
                        if (p1IsBye && !p2IsBye) {
                            autoWinner = p2;
                        } else if (p2IsBye && !p1IsBye) {
                            autoWinner = p1;
                        } else {
                            // ë‘˜ ë‹¤ ì‚¬ëŒ / ë‘˜ ë‹¤ ë¶€ì „ìŠ¹ / ë‘˜ ë‹¤ ë¹ˆì¹¸ -> ìë™ ì²˜ë¦¬ ì•ˆ í•¨
                            continue;
                        }

                        // ìŠ¹ì ê¸°ë¡
                        match.winner = autoWinner;

                        // ë‹¤ìŒ ë¼ìš´ë“œì— ìë™ ë°°ì¹˜
                        if (rIndex < bracketData.length - 1) {
                            const nextRound = bracketData[rIndex + 1];
                            const nextMatchIndex = Math.floor(mIndex / 2);
                            const slotInNext = mIndex % 2;

                            if (!nextRound[nextMatchIndex].players[slotInNext]) {
                                nextRound[nextMatchIndex].players[slotInNext] = autoWinner;
                            }
                        }

                        changed = true;
                    }
                }
            }
        };

        const updateChampionDisplay = () => {
            if (!bracketData) return;

            const lastRoundIndex = bracketData.length - 1;
            const finalMatch = bracketData[lastRoundIndex][0];

            if (!finalMatch.winner) {
                winnerNameEl.textContent = "-";
                runnerUpNameEl.textContent = "-";
                resultEl.classList.add("hidden");
                return;
            }

            const winner = finalMatch.winner;
            const [p1, p2] = finalMatch.players;
            let runnerUp = "-";
            if (p1 && p2) {
                runnerUp = p1 === winner ? p2 : p1;
            }

            winnerNameEl.textContent = winner;
            runnerUpNameEl.textContent = runnerUp;
            resultEl.classList.remove("hidden");
        };

        const handleWinnerClick = (matchDiv, clickedBtn) => {
            const rIndex = parseInt(matchDiv.dataset.roundIndex, 10);
            const mIndex = parseInt(matchDiv.dataset.matchIndex, 10);
            const data = bracketData[rIndex][mIndex];

            const nameSpan = clickedBtn.querySelector(".player-name");
            const clickedName = nameSpan.textContent.trim();
            if (!clickedName || clickedName === "ëŒ€ê¸°" || clickedName === "ë¶€ì „ìŠ¹") return;

            data.winner = clickedName;

            if (rIndex < bracketData.length - 1) {
                const nextRound = bracketData[rIndex + 1];
                const nextMatchIndex = Math.floor(mIndex / 2);
                const slotInNext = mIndex % 2;
                nextRound[nextMatchIndex].players[slotInNext] = clickedName;
            }

            autoAdvanceByes();
            refreshMatchTexts();
            updateChampionDisplay();
            if (window.rebuildAiPrompt) window.rebuildAiPrompt();
        };

        const resetBracket = () => {
            bracketData = null;
            seedsForDisplay = [];
            bracketInnerEl.innerHTML = "";
            bracketEl.classList.add("hidden");
            resultEl.classList.add("hidden");
            winnerNameEl.textContent = "-";
            runnerUpNameEl.textContent = "-";
            seedContainer.innerHTML = `
                <p class="text-xs text-slate-500">
                    ì™¼ìª½ì— ì°¸ê°€ì ì´ë¦„ì„ ì…ë ¥í•˜ê³ <br>
                    <b>ã€Œëœë¤ ì¶”ì²¨ &amp; ëŒ€ì§„í‘œ ìƒì„±ã€</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                </p>`;
            if (window.rebuildAiPrompt) window.rebuildAiPrompt();
        };

        generateBtn.addEventListener("click", () => {
            const raw = playerInputEl.value
                .split("\n")
                .map(v => v.trim())
                .filter(v => v.length > 0);

            if (raw.length < 2) {
                alert("ìµœì†Œ 2ëª… ì´ìƒ ì…ë ¥í•´ì•¼ ëŒ€ì§„í‘œë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”.");
                return;
            }

            let entries; // ë‹¨ì‹ì´ë©´ 'ì´ë¦„', ë³µì‹ì´ë©´ 'A / B' íŒ€ ì´ë¦„ë“¤

            if (matchType === 'single') {
                // ğŸ”¹ ë‹¨ì‹: ê¸°ì¡´ì²˜ëŸ¼ ê·¸ëƒ¥ ì…”í”Œ
                entries = shuffleArray([...raw]);
            } else {
                // ğŸ”¹ ë³µì‹: ë‘ ëª…ì”© í•œ íŒ€ìœ¼ë¡œ ë¬¶ê¸°
                if (raw.length < 4) {
                    alert("ë³µì‹ì€ ìµœì†Œ 4ëª…(2íŒ€) ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                    return;
                }
                if (raw.length % 2 !== 0) {
                    alert(`ë³µì‹ì€ ì§ìˆ˜ ì¸ì›ì´ í•„ìš”í•©ë‹ˆë‹¤. (í˜„ì¬ ${raw.length}ëª…)`);
                    return;
                }

                const shuffled = shuffleArray([...raw]);
                const teams = [];
                for (let i = 0; i < shuffled.length; i += 2) {
                    teams.push(`${shuffled[i]} / ${shuffled[i + 1]}`);
                }
                entries = teams;
            }

            // ê³µí†µ: ì—”íŠ¸ë¦¬ ìˆ˜ ì œí•œ
            if (entries.length > 16) {
                alert(`${matchType === 'single' ? 'ë‹¨ì‹' : 'ë³µì‹'}ì€ ìµœëŒ€ 16${matchType === 'single' ? 'ëª…' : 'íŒ€'}ê¹Œì§€ë§Œ ì§€ì›í•©ë‹ˆë‹¤. ì•ì—ì„œ 16ê°œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.`);
                entries = entries.slice(0, 16);
            }

            const size = getBracketSize(entries.length);
            bracketSize = size;

    // ğŸ”¹ ì‹¤ì œ ì°¸ê°€ì / ë¶€ì „ìŠ¹ ë”°ë¡œ ê´€ë¦¬
    const needed = size - entries.length;          // í•„ìš”í•œ ë¶€ì „ìŠ¹ ìˆ˜
    const realPlayers = [...entries];              // ì´ë¯¸ ë‹¨ì‹/ë³µì‹ì— ë§ê²Œ ì…”í”Œëœ ì—”íŠ¸ë¦¬
    const byes = Array(needed).fill("ë¶€ì „ìŠ¹");     // ë¶€ì „ìŠ¹ ëª©ë¡

    // ğŸ”¹ "ê° ê²½ê¸°ë‹¹ ë¶€ì „ìŠ¹ì€ ìµœëŒ€ 1ëª…"ì´ ë˜ë„ë¡ ì¬ë°°ì¹˜
    const matchCount = size / 2;
    const players = [];
    let realIdx = 0;
    let byeIdx = 0;

    for (let m = 0; m < matchCount; m++) {
        let a = "";
        let b = "";

        if (byeIdx < byes.length) {
            // ë¨¼ì € ë¶€ì „ìŠ¹ 1ëª… ë°°ì¹˜ + ì‹¤ì œ ì°¸ê°€ì 1ëª…
            a = byes[byeIdx++];
            if (realIdx < realPlayers.length) {
                b = realPlayers[realIdx++];
            }
        } else {
            // ë‚¨ì€ ê±´ ì „ë¶€ ì‹¤ì œ ì°¸ê°€ìë¼ë¦¬ ë°°ì¹˜
            if (realIdx < realPlayers.length) {
                a = realPlayers[realIdx++];
            }
            if (realIdx < realPlayers.length) {
                b = realPlayers[realIdx++];
            }
        }

        // ë¹ˆ ê°’ì´ ìƒê¸°ë©´ ì•ˆì „í•˜ê²Œ ë¶€ì „ìŠ¹ìœ¼ë¡œ ì±„ìš°ê¸°
        players.push(a || "ë¶€ì „ìŠ¹");
        players.push(b || "ë¶€ì „ìŠ¹");
    }

    // ğŸ”¹ ë¸Œë˜í‚· êµ¬ì¡° ì´ˆê¸°í™” + 1ë¼ìš´ë“œ ë°°ì¹˜
    bracketData = initBracketStructure(size);
    const firstRound = bracketData[0];
    for (let i = 0; i < firstRound.length; i++) {
        firstRound[i].players[0] = players[i * 2] || "";
        firstRound[i].players[1] = players[i * 2 + 1] || "";
    }
            // ë¶€ì „ìŠ¹ ìë™ ì§„ì¶œ + UI ê°±ì‹ 
            autoAdvanceByes();
            renderSeedTable(players, size);
            renderBracketDOM();
            refreshMatchTexts();
            updateChampionDisplay();
            if (window.rebuildAiPrompt) window.rebuildAiPrompt();
        });

        resetBtn.addEventListener("click", () => {
            resetBracket();
            playerInputEl.value = "";
            if (window.rebuildAiPrompt) window.rebuildAiPrompt();
        });

        bracketInnerEl.addEventListener("click", (e) => {
            const btn = e.target.closest(".player-btn");
            if (!btn || btn.classList.contains("empty")) return;
            const matchDiv = btn.closest(".match");
            if (!matchDiv) return;
            handleWinnerClick(matchDiv, btn);
        });
    });
</script>

</body>
</html>
